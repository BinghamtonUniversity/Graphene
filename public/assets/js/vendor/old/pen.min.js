!function(e){var t,n,i={};i.is=function(e,t){return Object.prototype.toString.call(e).slice(8,-1)===t},i.copy=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];e[n]=this.is(i,"Object")?this.copy({},i):this.is(i,"Array")?this.copy([],i):i}return e},i.log=function(e,t){(window._pen_debug_mode_on||t)&&console.log("%cPEN DEBUGGER: %c"+e,"font-family:arial,sans-serif;color:#1abf89;line-height:2em;","font-family:cursor,monospace;color:#333;")},i.shift=function(e,t,n){n=n||50;var i,o=this["_shift_fn"+e],r="shift_timeout"+e;o?o.concat([t,n]):o=[[t,n]],i=o.pop(),clearTimeout(this[r]),this[r]=setTimeout(function(){i[0]()},n)},i.merge=function(t){var n={"class":"pen",debug:!1,stay:t.stay||!t.debug,textarea:'<textarea name="content"></textarea>',list:["blockquote","h2","h3","p","insertorderedlist","insertunorderedlist","inserthorizontalrule","indent","outdent","bold","italic","underline","createlink"]};return 1===t.nodeType?n.editor=t:t.match&&t.match(/^#[\S]+$/)?n.editor=e.getElementById(t.slice(1)):n=i.copy(n,t),n},t=function(t){if(!t)return i.log("can't find config",!0);var n=i.merge(t);if(1!==n.editor.nodeType)return i.log("can't find editor");n.debug&&(window._pen_debug_mode_on=!0);var o=n.editor;o.classList.add(n.class);var r=o.getAttribute("contenteditable");r||o.setAttribute("contenteditable","true"),this.config=n,this._sel=e.getSelection(),this.actions(),this.toolbar(),this.markdown&&this.markdown.init(this),this.config.stay&&this.stay()},t.prototype._effectNode=function(e,t){for(var n=[];e!==this.config.editor;)e.nodeName.match(/(?:[pubia]|h[1-6]|blockquote|[uo]l|li)/i)&&n.push(t?e.nodeName.toLowerCase():e),e=e.parentNode;return n},t.prototype.nostyle=function(){var e=this.config.editor.querySelectorAll("[style]");return[].slice.call(e).forEach(function(e){e.removeAttribute("style")}),this},t.prototype.toolbar=function(){for(var t=this,n="",o=0,r=this.config.list;o<r.length;o++){var s=r[o],a="pen-icon icon-"+s;n+='<i class="'+a+'" data-action="'+s+'">'+(s.match(/^h[1-6]|p$/i)?s.toUpperCase():"")+"</i>","createlink"===s&&(n+='<input class="pen-input" placeholder="http://" />')}var l=e.createElement("div");l.setAttribute("class",this.config.class+"-menu pen-menu"),l.innerHTML=n,l.style.display="none",e.body.appendChild(this._menu=l);var c=function(){"block"===l.style.display&&t.menu()};window.addEventListener("resize",c),window.addEventListener("scroll",c);var u=this.config.editor,d=function(){t._isDestroyed||i.shift("toggle_menu",function(){var e=t._sel;e.isCollapsed?t._menu.style.display="none":(t._range=e.getRangeAt(0),t.menu().highlight())},200)};return u.addEventListener("mouseup",d),u.addEventListener("keyup",d),l.addEventListener("click",function(e){var n=e.target.getAttribute("data-action");if(n){var i=function(e){t._sel.removeAllRanges(),t._sel.addRange(t._range),t._actions(n,e),t._range=t._sel.getRangeAt(0),t.highlight().nostyle().menu()};if("createlink"===n){var o,r=l.getElementsByTagName("input")[0];return r.style.display="block",r.focus(),o=function(e){return e.style.display="none",e.value?i(e.value.replace(/(^\s+)|(\s+$)/g,"").replace(/^(?!http:\/\/|https:\/\/)(.*)$/,"http://$1")):(n="unlink",void i())},r.onkeypress=function(e){return 13===e.which?o(e.target):void 0},r.onkeypress}i()}}),this},t.prototype.highlight=function(){var e,t=this._sel.focusNode,n=this._effectNode(t),i=this._menu,o=i.querySelector("input");return[].slice.call(i.querySelectorAll(".active")).forEach(function(e){e.classList.remove("active")}),o&&(o.style.display="none",o.value=""),e=function(e){var t=".icon-"+e,n=i.querySelector(t);return n&&n.classList.add("active")},n.forEach(function(t){var n=t.nodeName.toLowerCase();switch(n){case"a":return i.querySelector("input").value=t.href,e("createlink");case"i":return e("italic");case"u":return e("underline");case"b":return e("bold");case"ul":return e("insertunorderedlist");case"ol":return e("insertorderedlist");case"ol":return e("insertorderedlist");case"li":return e("indent");default:e(n)}}),this},t.prototype.actions=function(){var e,t,n,o,r=this;return e={block:/^(?:p|h[1-6]|blockquote|pre)$/,inline:/^(?:bold|italic|underline|insertorderedlist|insertunorderedlist|indent|outdent)$/,source:/^(?:insertimage|createlink|unlink)$/,insert:/^(?:inserthorizontalrule|insert)$/},n=function(e,t){var n=" to exec 「"+e+"」 command"+(t?" with value: "+t:"");i.log(document.execCommand(e,!1,t)&&r.config.debug?"success"+n:"fail"+n)},o=function(e){for(var t=r._sel.getRangeAt(0),i=t.startContainer;1!==i.nodeType;)i=i.parentNode;return t.selectNode(i),t.collapse(!1),n(e)},t=function(e){if(-1!==r._effectNode(r._sel.getRangeAt(0).startContainer,!0).indexOf(e)){if("blockquote"===e)return document.execCommand("outdent",!1,null);e="p"}return n("formatblock",e)},this._actions=function(r,s){r.match(e.block)?t(r):r.match(e.inline)||r.match(e.source)?n(r,s):r.match(e.insert)?o(r):this.config.debug&&i.log("can not find command function for name: "+r+(s?", value: "+s:""))},this},t.prototype.menu=function(){var e=this._range.getBoundingClientRect(),t=10,n=e.top-t,i=e.left+e.width/2,o=this._menu,r={x:0,y:0},s=this._stylesheet;if(void 0===this._stylesheet){var a=document.createElement("style");document.head.appendChild(a),this._stylesheet=s=a.sheet}return o.style.display="block",r.x=i-o.clientWidth/2,r.y=n-o.clientHeight,s.cssRules.length>0&&s.deleteRule(0),r.x<0?(r.x=0,s.insertRule(".pen-menu:after { left: "+i+"px; }",0)):s.insertRule(".pen-menu:after { left: 50%; }",0),r.y<0?(o.classList.toggle("pen-menu-below",!0),r.y=e.top+e.height+t):o.classList.toggle("pen-menu-below",!1),o.style.top=r.y+"px",o.style.left=r.x+"px",this},t.prototype.stay=function(){var e=this;window.onbeforeunload||(window.onbeforeunload=function(){return e._isDestroyed?void 0:"Are you going to leave here?"})},t.prototype.destroy=function(e){var t=e?!1:!0,n=e?"setAttribute":"removeAttribute";return e||(this._sel.removeAllRanges(),this._menu.style.display="none"),this._isDestroyed=t,this.config.editor[n]("contenteditable",""),this},t.prototype.rebuild=function(){return this.destroy("it's a joke")},n=function(e){if(!e)return i.log("can't find config",!0);var t=i.merge(e),n=t.editor.getAttribute("class");return n=n?n.replace(/\bpen\b/g,"")+" pen-textarea "+t.class:"pen pen-textarea",t.editor.setAttribute("class",n),t.editor.innerHTML=t.textarea,t.editor},this.Pen=e.getSelection?t:n}(document);
